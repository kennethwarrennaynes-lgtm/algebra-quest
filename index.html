<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Quest: Ultimate Edition</title>
    <style>
        /* --- THEME: NEBULA PURPLE --- */
        :root {
            --primary: #6c5ce7;
            --primary-dark: #4834d4;
            --secondary: #a29bfe;
            --accent: #00cec9;
            --bg-dark: #2d3436;
            --bg-light: #f5f6fa;
            --text: #2d3436;
            --success: #00b894;
            --error: #d63031;
            --card-shadow: 0 8px 30px rgba(108, 92, 231, 0.2);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }

        body { display: flex; min-height: 100vh; background: var(--bg-light); color: var(--text); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px; background: var(--bg-dark); color: white;
            padding: 20px; position: fixed; height: 100vh; overflow-y: auto;
            border-right: 5px solid var(--primary); z-index: 100;
        }

        .brand {
            font-size: 1.8em; font-weight: 800; text-align: center;
            color: var(--accent); text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 40px; cursor: pointer;
            text-shadow: 0 0 10px rgba(0, 206, 201, 0.5);
        }

        .nav-btn {
            display: block; width: 100%; padding: 15px 20px; margin-bottom: 10px;
            background: rgba(255,255,255,0.05); border: none; color: #b2bec3;
            text-align: left; cursor: pointer; border-radius: 10px; font-weight: 600;
            transition: 0.3s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; padding-left: 25px; }
        .nav-btn.active { background: var(--primary); color: white; border-left: 5px solid var(--accent); }
        .nav-btn.locked { opacity: 0.5; cursor: not-allowed; position: relative; }
        .nav-btn.locked::after { content: 'üîí'; position: absolute; right: 20px; }
        .nav-btn.completed::after { content: '‚úì'; position: absolute; right: 20px; color: var(--success); }

        .xp-box {
            margin-top: 40px; background: rgba(0,0,0,0.3); padding: 20px;
            border-radius: 15px; text-align: center; border: 2px solid var(--accent);
        }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 300px; flex: 1; padding: 40px; width: calc(100% - 300px); }

        .progress-bar {
            width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px;
            margin-bottom: 20px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary));
            width: 0%; transition: width 0.5s ease;
        }

        /* --- PHASE NAV --- */
        .phase-nav {
            display: flex; gap: 10px; margin-bottom: 30px; visibility: hidden;
            background: white; padding: 15px; border-radius: 15px; box-shadow: var(--card-shadow);
        }
        .phase-nav.visible { visibility: visible; }

        .phase-btn {
            padding: 10px 20px; border: none; background: transparent; font-weight: 700;
            color: #636e72; cursor: pointer; border-radius: 20px; transition: 0.2s;
        }
        .phase-btn:hover { background: #f1f2f6; color: var(--primary); }
        .phase-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }

        /* --- CONTENT CARD --- */
        .content-card {
            background: white; padding: 50px; border-radius: 25px;
            box-shadow: var(--card-shadow); min-height: 60vh;
            animation: fadeIn 0.5s ease; position: relative; padding-bottom: 100px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { color: var(--primary-dark); font-size: 2.5em; margin-bottom: 20px; }
        h2 { color: var(--primary); border-bottom: 3px solid var(--secondary); padding-bottom: 10px; margin-bottom: 20px; }
        h3 { color: #2d3436; margin: 30px 0 15px 0; font-size: 1.4em; border-left: 5px solid var(--accent); padding-left: 10px; }
        p, li { line-height: 1.8; font-size: 1.1em; color: #444; margin-bottom: 15px; }

        /* --- MATH & INTERACTIVE --- */
        .math-text { font-family: 'Courier New', monospace; font-weight: bold; background: #eef; padding: 2px 6px; border-radius: 4px; color: var(--primary-dark); }
        
        .game-board {
            background: #f8f9fa; border: 3px dashed #b2bec3; border-radius: 20px;
            padding: 30px; text-align: center; margin: 20px 0; min-height: 400px;
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
        }

        .mission-brief {
            background: #e3f2fd; color: #0d47a1; padding: 20px; border-radius: 10px;
            margin-bottom: 25px; width: 100%; font-weight: normal; border-left: 5px solid #2196f3;
            text-align: left;
        }
        .mission-brief strong { display: block; margin-bottom: 5px; font-size: 1.2em; }

        .highlightable { 
            cursor: pointer; padding: 8px 12px; border-radius: 8px; border: 2px solid #ddd; 
            transition: 0.2s; display: inline-block; font-size: 1.5em; font-family: 'Courier New', monospace; font-weight: bold;
            background: white; margin: 0 5px;
        }
        .highlightable:hover { background: #dfe6e9; border-color: var(--primary); transform: translateY(-2px); }
        .highlightable.selected { background: var(--success); color: white; border-color: var(--success); }

        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 30px;
            border-radius: 50px; font-weight: bold; font-size: 1.1em; cursor: pointer;
            margin: 10px; transition: 0.3s; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }
        .btn:hover { transform: translateY(-3px); background: var(--primary-dark); }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-next { position: absolute; bottom: 40px; right: 40px; background: var(--success); }
        .btn-disabled { background: #b2bec3; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Game Elements */
        .token { background: var(--accent); padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; display: inline-block; font-weight: bold; color: white; }
        
        /* --- VISUAL SCALE CSS --- */
        .scale-wrapper {
            width: 400px; height: 180px; position: relative; margin: 40px auto;
        }
        .scale-stand {
            width: 10px; height: 120px; background: #b2bec3; position: absolute; bottom: 0; left: 195px;
        }
        .scale-base {
            width: 100px; height: 10px; background: #2d3436; position: absolute; bottom: 0; left: 150px; border-radius: 5px;
        }
        .scale-beam {
            width: 340px; height: 8px; background: #2d3436; position: absolute; top: 60px; left: 30px;
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transform-origin: center; z-index: 2;
        }
        .plate-rope-l { width: 2px; height: 50px; background: #b2bec3; position: absolute; top: 0; left: 0; }
        .plate-rope-r { width: 2px; height: 50px; background: #b2bec3; position: absolute; top: 0; right: 0; }
        
        .plate {
            width: 70px; height: 10px; background: #2d3436; position: absolute; top: 50px;
            display: flex; justify-content: center;
        }
        .plate-l { left: -35px; } /* Relative to rope */
        .plate-r { right: -35px; }

        .scale-content {
            position: absolute; bottom: 10px; width: 60px; text-align: center; font-weight: bold; color: var(--primary);
        }

        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            border-radius: 15px; margin: 30px 0; border: 4px solid var(--primary);
        }
        .video-container iframe { position: absolute; top:0; left:0; width: 100%; height: 100%; }

        /* --- ELABORATE INTERACTION STYLES --- */
        .elaborate-box {
            background: #fff; border: 1px solid #ddd; border-left: 5px solid var(--primary);
            padding: 20px; border-radius: 10px; margin-bottom: 20px;
        }
        .elaborate-input { padding: 10px; border: 2px solid #ccc; border-radius: 5px; width: 150px; font-size: 1em; }

        /* --- QUIZ STYLES --- */
        .quiz-item { background: #f1f2f6; padding: 20px; border-radius: 15px; margin-bottom: 15px; }
        .quiz-opt { 
            display: block; background: white; padding: 15px; margin: 10px 0; 
            border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: 0.2s;
        }
        .quiz-opt:hover { border-color: var(--primary); background: #eef; }
        .quiz-opt.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        .quiz-score-box { text-align: center; padding: 40px; background: #eef; border-radius: 20px; margin-top: 20px; }

        .feedback {
            margin-top: 20px; padding: 15px; border-radius: 10px; font-weight: bold;
            display: none; font-size: 1.2em; width: 80%;
        }
        .feedback.correct { background: #d4edda; color: #155724; display: block; border: 1px solid #c3e6cb; }
        .feedback.wrong { background: #f8d7da; color: #721c24; display: block; border: 1px solid #f5c6cb; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand" onclick="window.loadHome()">ALGEBRA QUEST</div>
        
        <button class="nav-btn active" onclick="window.loadHome()">üè† Mission Control</button>
        <div style="margin: 20px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
        
        <button id="nav-1" class="nav-btn" onclick="window.loadLessonIntro(1)">1. Anatomy of Algebra</button>
        <button id="nav-2" class="nav-btn locked" onclick="window.loadLessonIntro(2)">2. Language of Algebra</button>
        <button id="nav-3" class="nav-btn locked" onclick="window.loadLessonIntro(3)">3. Properties of Equality</button>
        <button id="nav-4" class="nav-btn locked" onclick="window.loadLessonIntro(4)">4. Solving Equations</button>

        <div class="xp-box">
            <div style="font-size:0.8em; text-transform:uppercase; color:#b2bec3;">Total XP</div>
            <div id="totalXP" style="font-size:2.5em; font-weight:800; color:var(--accent);">0</div>
        </div>
    </div>

    <div class="main-content">
        <div class="progress-bar"><div id="pBar" class="progress-fill"></div></div>
        
        <div id="phaseNav" class="phase-nav">
            <button class="phase-btn" onclick="window.setPhase('engage')">‚ú® Engage</button>
            <button class="phase-btn" onclick="window.setPhase('explore')">üîç Explore</button>
            <button class="phase-btn" onclick="window.setPhase('explain')">üìö Explain</button>
            <button class="phase-btn" onclick="window.setPhase('elaborate')">üöÄ Elaborate</button>
            <button class="phase-btn" onclick="window.setPhase('evaluate')">‚úÖ Evaluate</button>
        </div>

        <div id="contentArea" class="content-card">
            <h2 style="color:#b2bec3; text-align:center; margin-top:50px;">Loading Mission Control...</h2>
        </div>
    </div>

<script>
// Defining functions globally to ensure HTML onclick access
(function() {
    /* =========================================
       DATA STORE
       ========================================= */
    let currentLesson = 1;
    let unlockedLessons = 1;
    let xp = 0;
    let quizAnswers = []; 
    let currentPhase = 'engage';
    let gameRound = 0;
    let gameScore = 0;
    let currentBuilder = "";

    const content = {
        home: `
            <div style="text-align:center;">
                <h1 style="font-size:3em; color:var(--primary);">Welcome to Algebra Quest</h1>
                <p style="font-size:1.5em; color:#636e72;">Unlock the secrets of the Unknown Variable.</p>
                <hr style="width:50%; margin:30px auto; border:1px solid #ddd;">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px;">
                <div>
                    <h3>üéØ Purpose</h3>
                    <p>This platform is designed to help you master the fundamentals of Algebra through interactive challenges.</p>
                    <h3>üß† The 5E Model</h3>
                    <ul style="line-height:1.8;">
                        <li><strong>Engage:</strong> Hook your interest with a game.</li>
                        <li><strong>Explore:</strong> Hands-on activities to discover rules.</li>
                        <li><strong>Explain:</strong> Detailed videos and definitions.</li>
                        <li><strong>Elaborate:</strong> Harder problems and real-world use.</li>
                        <li><strong>Evaluate:</strong> A final quiz to test your skill.</li>
                    </ul>
                </div>
                <div style="background:#f8f9fa; padding:30px; border-radius:20px; border-left:5px solid var(--accent);">
                    <h3>üöÄ Your Mission</h3>
                    <p>Complete all 4 Levels to become an Algebra Master.</p>
                    <ul style="list-style:none; padding:0;">
                        <li style="margin-bottom:10px;"><strong>Level 1:</strong> Anatomy (Parts of expressions)</li>
                        <li style="margin-bottom:10px;"><strong>Level 2:</strong> Language (Translating English to Math)</li>
                        <li style="margin-bottom:10px;"><strong>Level 3:</strong> Properties (Rules of the game)</li>
                        <li style="margin-bottom:10px;"><strong>Level 4:</strong> Solving (Finding the unknown)</li>
                    </ul>
                    <button class="btn" style="width:100%" onclick="window.loadLessonIntro(1)">Start Level 1 ‚û°Ô∏è</button>
                </div>
            </div>
        `,
        lessons: {
            1: {
                intro: `
                    <h1>Level 1: Anatomy of Algebra</h1>
                    <div style="background:#e1bee7; padding:20px; border-radius:15px; margin:20px 0;">
                        <h3>üéØ Objectives (Lesson 1)</h3>
                        <ul>
                            <li>Identify the <strong>terms</strong> in an algebraic expression.</li>
                            <li>Distinguish between <strong>variables</strong>, <strong>constants</strong>, and <strong>numerical coefficients</strong>.</li>
                            <li>Determine the number of terms in an expression.</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="window.startLesson(1)">Enter the Lab ‚û°Ô∏è</button>
                `,
                explain: `
                    <h2>üìö Explain: The Anatomy Charts</h2>
                    <div class="video-container"><iframe src="https://www.youtube.com/embed/_90sfL5XM_Q" allowfullscreen></iframe></div>
                    <h3>1. Terms</h3>
                    <p>An algebraic expression is built from parts called <strong>terms</strong>. A term can be a number, a variable, or a product of both. Terms are separated by <span class="math-text">+</span> or <span class="math-text">-</span> signs. The sign belongs to the term immediately to its <em>left</em>.</p>
                    <h3>2. Variables</h3>
                    <p>A <strong>variable</strong> is a symbol (usually a letter like x, y, a, b) that represents an unknown or changeable value.</p>
                    <h3>3. Constants</h3>
                    <p>A <strong>constant</strong> is a number on its own. Its value never changes because it is not multiplied by a variable.</p>
                    <h3>4. Coefficients</h3>
                    <p>The <strong>numerical coefficient</strong> is the number multiplied by the variable.</p>
                    <div style="background:#fff3cd; padding:15px; border-radius:10px; border-left:5px solid #ffc107;">
                        <strong>‚ö†Ô∏è The Invisible 1 Rule:</strong> If a variable has no number (e.g., <span class="math-text">x</span>), the coefficient is <strong>1</strong>. If it is <span class="math-text">-x</span>, the coefficient is <strong>-1</strong>.
                    </div>
                `,
                elaborate: `
                    <h2>üöÄ Elaborate: Advanced Diagnosis</h2>
                    <div class="elaborate-box">
                        <h3>1. The Invisible One</h3>
                        <p>What is the coefficient of <span class="math-text">y</span> in <span class="math-text">5x + y</span>?</p>
                        <input type="text" id="l1-ex1" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l1-ex1','1')">Check</button>
                    </div>
                    <div class="elaborate-box">
                        <h3>2. The Negative Sign</h3>
                        <p>What is the constant in <span class="math-text">3x - 8</span>?</p>
                        <input type="text" id="l1-ex2" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l1-ex2','-8')">Check</button>
                    </div>
                    <div class="elaborate-box">
                        <h3>3. Fraction Disguise</h3>
                        <p>Identify the coefficient in <span class="math-text">x/2</span> (Enter as decimal 0.5 or fraction 1/2).</p>
                        <input type="text" id="l1-ex3" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkMulti('l1-ex3',['0.5','1/2'])">Check</button>
                    </div>
                    <div class="elaborate-box">
                        <h3>4. Term Counting</h3>
                        <p>How many terms in <span class="math-text">2x + 3y - z + 5</span>?</p>
                        <button class="btn btn-outline" onclick="alert('Correct! The terms are 2x, 3y, -z, and 5.')">4 Terms</button>
                        <button class="btn btn-outline" onclick="alert('Try again. Count items separated by + or -.')">3 Terms</button>
                    </div>
                    <div class="elaborate-box">
                        <h3>5. Geometry Formula</h3>
                        <p>In <span class="math-text">C = 2œÄr</span>, is 'r' a Constant or Variable?</p>
                        <button class="btn btn-outline" onclick="alert('Correct! Radius changes.')">Variable</button>
                        <button class="btn btn-outline" onclick="alert('Incorrect. The radius can change size.')">Constant</button>
                    </div>
                `
            },
            2: {
                intro: `
                    <h1>Level 2: Language of Algebra</h1>
                    <div style="background:#e1bee7; padding:20px; border-radius:15px; margin:20px 0;">
                        <h3>üéØ Objectives (Lesson 2)</h3>
                        <ul>
                            <li>Differentiate between <strong>algebraic expressions</strong> and <strong>equations</strong>.</li>
                            <li>Translate verbal phrases into mathematical expressions.</li>
                            <li>Identify and correct use of inequality symbols ($<, >, \le, \ge, \ne$).</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="window.startLesson(2)">Start Translating ‚û°Ô∏è</button>
                `,
                explain: `
                    <h2>üìö Explain: Translation Rules</h2>
                    <div class="video-container"><iframe src="https://www.youtube.com/embed/Xm8nQm1KKuE" allowfullscreen></iframe></div>
                    <h3>1. Expression vs. Equation</h3>
                    <p><strong>Expression:</strong> A phrase. NO equal sign (e.g., <span class="math-text">3x + 5</span>).</p>
                    <p><strong>Equation:</strong> A complete sentence. MUST have an equal sign (e.g., <span class="math-text">3x + 5 = 10</span>).</p>
                    <h3>2. The "Switch Words"</h3>
                    <p>Phrases like <strong>"Less than"</strong> and <strong>"Subtracted from"</strong> require you to FLIP the order.</p>
                    <ul><li>"5 less than x" &rarr; <span class="math-text">x - 5</span></li></ul>
                    <h3>3. The 5 Inequality Symbols</h3>
                    <ul>
                        <li><span class="math-text">&lt;</span> <strong>Is less than:</strong> Smaller.</li>
                        <li><span class="math-text">&gt;</span> <strong>Is greater than:</strong> Larger.</li>
                        <li><span class="math-text">&le;</span> <strong>Is less than or equal to:</strong> (At most, Maximum).</li>
                        <li><span class="math-text">&ge;</span> <strong>Is greater than or equal to:</strong> (At least, Minimum).</li>
                        <li><span class="math-text">&ne;</span> <strong>Is not equal to:</strong> Different values.</li>
                    </ul>
                `,
                elaborate: `
                    <h2>üöÄ Elaborate: 5 Translation Challenges</h2>
                    <div class="elaborate-box"><h3>1. The Switch Word Trap</h3><p>Translate: "10 subtracted from x"</p><input type="text" id="l2-ex1" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l2-ex1','x-10')">Check</button></div>
                    <div class="elaborate-box"><h3>2. The "Is" Rule</h3><p>Translate: "Twice a number is 14"</p><input type="text" id="l2-ex2" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l2-ex2','2x=14')">Check</button></div>
                    <div class="elaborate-box"><h3>3. Inequality: Capacity</h3><p>The elevator holds <strong>at most</strong> 10 people. (Use p).</p><button class="btn btn-outline" onclick="alert('Correct! p ‚â§ 10')">p ‚â§ 10</button> <button class="btn btn-outline" onclick="alert('Wrong. < excludes 10.')">p < 10</button></div>
                    <div class="elaborate-box"><h3>4. Inequality: Age</h3><p>You must be <strong>at least</strong> 18 to vote. (Use a).</p><input type="text" id="l2-ex4" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkMulti('l2-ex4',['a>=18','a=>18'])">Check</button></div>
                    <div class="elaborate-box"><h3>5. Complex Sentence</h3><p>"Five more than the product of 3 and a number."</p><button class="btn btn-outline" onclick="alert('Correct! 3x + 5')">Reveal Answer</button></div>
                `
            },
            3: {
                intro: `
                    <h1>Level 3: Properties of Equality</h1>
                    <div style="background:#e1bee7; padding:20px; border-radius:15px; margin:20px 0;">
                        <h3>üéØ Objectives (Lesson 3)</h3>
                        <ul>
                            <li>Identify Commutative, Associative, and Distributive Properties.</li>
                            <li>Apply properties to simplify expressions.</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="window.startLesson(3)">Learn the Laws ‚û°Ô∏è</button>
                `,
                explain: `
                    <h2>üìö Explain: The Big Three Properties</h2>
                    <div class="video-container"><iframe src="https://www.youtube.com/embed/DKC74YKJpNY" allowfullscreen></iframe></div>
                    <h3>1. Commutative Property (Order)</h3>
                    <p>Changing the <strong>order</strong> of addition or multiplication does not change the result.</p>
                    <p><em>Rule:</em> <span class="math-text">a + b = b + a</span></p>
                    <h3>2. Associative Property (Grouping)</h3>
                    <p>Changing the <strong>grouping</strong> (parentheses) does not change the result.</p>
                    <p><em>Rule:</em> <span class="math-text">(a + b) + c = a + (b + c)</span></p>
                    <h3>3. Distributive Property</h3>
                    <p>Multiplying a value across a sum inside parentheses.</p>
                    <p><em>Rule:</em> <span class="math-text">a(b + c) = ab + ac</span></p>
                    <h3>4. Identity & Inverse</h3>
                    <p><strong>Identity:</strong> 0 (Add) or 1 (Mult). Leaves value unchanged.</p>
                    <p><strong>Inverse:</strong> Opposites (-x) or Reciprocals (1/x). Cancels to identity.</p>
                `,
                elaborate: `
                    <h2>üöÄ Elaborate: 5 Property Proofs</h2>
                    <div class="elaborate-box"><h3>1. Simplify using Distributive</h3><p>Simplify <span class="math-text">2(x + 4)</span></p><input type="text" id="l3-ex1" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l3-ex1','2x+8')">Check</button></div>
                    <div class="elaborate-box"><h3>2. Identify the Property</h3><p><span class="math-text">5 + 3 = 3 + 5</span></p><button class="btn btn-outline" onclick="alert('Correct! Order changed.')">Commutative</button> <button class="btn btn-outline" onclick="alert('Incorrect.')">Associative</button></div>
                    <div class="elaborate-box"><h3>3. Justify the Step</h3><p>Step 1: <span class="math-text">3 + (4 + x)</span> -> Step 2: <span class="math-text">(3 + 4) + x</span></p><button class="btn btn-outline" onclick="alert('Correct! Grouping changed.')">Associative</button></div>
                    <div class="elaborate-box"><h3>4. Identity vs Inverse</h3><p>What number is the Additive Identity?</p><input type="text" id="l3-ex4" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l3-ex4','0')">Check</button></div>
                    <div class="elaborate-box"><h3>5. Distributing Negatives</h3><p>Simplify <span class="math-text">-3(x - 2)</span></p><button class="btn btn-outline" onclick="alert('Answer: -3x + 6')">Reveal Answer</button></div>
                `
            },
            4: {
                intro: `
                    <h1>Level 4: Solving Equations</h1>
                    <div style="background:#e1bee7; padding:20px; border-radius:15px; margin:20px 0;">
                        <h3>üéØ Objectives (Lesson 4)</h3>
                        <ul>
                            <li>Solve equations using APE and MPE.</li>
                            <li>Check solutions.</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="window.startLesson(4)">Start Solving ‚û°Ô∏è</button>
                `,
                explain: `
                    <h2>üìö Explain: Rules of Equality</h2>
                    <div class="video-container"><iframe src="https://www.youtube.com/embed/1nPsm-kL_Qw" allowfullscreen></iframe></div>
                    <h3>1. The Goal</h3>
                    <p>Isolate the variable (<span class="math-text">x = ___</span>) using <strong>Inverse Operations</strong>.</p>
                    <h3>2. Addition Property of Equality (APE)</h3>
                    <p>Adding/Subtracting the same number to both sides keeps the equation balanced.</p>
                    <h3>3. Multiplication Property of Equality (MPE)</h3>
                    <p>Multiplying/Dividing both sides by the same number keeps it balanced.</p>
                    <h3>4. Two-Step Strategy</h3>
                    <p>Always undo Addition/Subtraction <strong>FIRST</strong>, then undo Multiplication/Division.</p>
                `,
                elaborate: `
                    <h2>üöÄ Elaborate: 5 Solving Missions</h2>
                    <div class="elaborate-box"><h3>1. One-Step Equation</h3><p>Solve: <span class="math-text">x + 7 = 10</span></p><input type="text" id="l4-ex1" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l4-ex1','3')">Check</button></div>
                    <div class="elaborate-box"><h3>2. Error Analysis</h3><p>Problem: <span class="math-text">3x = 12</span>. Student says x = 9. Error?</p><button class="btn btn-outline" onclick="alert('Correct! They subtracted instead of dividing.')">Subtracted</button> <button class="btn btn-outline" onclick="alert('Incorrect.')">Added</button></div>
                    <div class="elaborate-box"><h3>3. Two-Step Equation</h3><p>Solve: <span class="math-text">2x + 1 = 11</span></p><input type="text" id="l4-ex3" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l4-ex3','5')">Check</button></div>
                    <div class="elaborate-box"><h3>4. Negative Variable</h3><p>Solve: <span class="math-text">-x = 5</span></p><input type="text" id="l4-ex4" class="elaborate-input"> <button class="btn btn-outline" onclick="window.checkExact('l4-ex4','-5')">Check</button></div>
                    <div class="elaborate-box"><h3>5. Checking Solutions</h3><p>Is x=4 a solution for <span class="math-text">3x - 2 = 10</span>?</p><button class="btn btn-outline" onclick="alert('Correct! 12-2 = 10.')">Yes</button> <button class="btn btn-outline" onclick="alert('Incorrect.')">No</button></div>
                `
            }
        },
        games: {
            l1_engage: { type: 'select', title: "Word Hunter", desc: "<strong>Mission:</strong> Identify the correct part of speech. The word is hidden in the sentence‚Äîclick the right one!",
                rounds: [
                    { q: "Noun (The object/thing)", parts: ["The", "fast", "dog"], correct: "dog" },
                    { q: "Adjective (The description)", parts: ["The", "blue", "car"], correct: "blue" },
                    { q: "Verb (The action)", parts: ["Birds", "fly", "high"], correct: "fly" },
                    { q: "Number", parts: ["Five", "cats", "sleep"], correct: "Five" },
                    { q: "Variable (The letter)", parts: ["x", "+", "5"], correct: "x" }
                ]
            },
            l1_explore: { type: 'clicker', title: "Algebra Autopsy", desc: "<strong>Mission:</strong> You are the surgeon. Click the specific organ (math part) requested.",
                rounds: [
                    { task: "Click the Coefficient", expr: "4x - 9", parts: ["4", "x", "- 9"], ans: "4" },
                    { task: "Click the Variable", expr: "3y + 2", parts: ["3", "y", "+ 2"], ans: "y" },
                    { task: "Click the Constant", expr: "a - 5", parts: ["a", "- 5"], ans: "- 5" },
                    { task: "Click the Coefficient", expr: "-x + 10", parts: ["-", "x", "+ 10"], ans: "-" },
                    { task: "Click the Constant", expr: "2œÄr", parts: ["2œÄ", "r"], ans: "2œÄ" }
                ]
            },
            l2_engage: { type: 'speed', title: "Symbol Sniper", desc: "<strong>Mission:</strong> Identify the correct math symbol for the phrase.",
                rounds: [
                    { q: "Increased by", opts: ["+", "-", "*"], a: "+" },
                    { q: "Product of", opts: ["‚Ä¢", "√∑", "+"], a: "‚Ä¢" },
                    { q: "Quotient", opts: ["-", "√∑", "="], a: "√∑" },
                    { q: "Is less than", opts: ["<", ">", "="], a: "<" },
                    { q: "Is at most", opts: ["‚â•", "‚â§", "<"], a: "‚â§" }
                ]
            },
            l2_explore: { type: 'builder', title: "Expression Builder", desc: "<strong>Mission:</strong> Click the blocks in order to build the correct math translation.",
                rounds: [
                    { q: "Sum of x and 5", blocks: ["5", "+", "x"], ans: "x+5" },
                    { q: "10 decreased by y", blocks: ["y", "10", "-"], ans: "10-y" },
                    { q: "5 less than x (Switch!)", blocks: ["-", "5", "x"], ans: "x-5" },
                    { q: "Twice a number", blocks: ["x", "2"], ans: "2x" },
                    { q: "10 subtracted from z", blocks: ["z", "10", "-"], ans: "z-10" }
                ]
            },
            l3_engage: { type: 'truth', title: "Truth Detector", desc: "<strong>Mission:</strong> Determine if the math statement is True or False.",
                rounds: [
                    { q: "5 + 3 = 3 + 5", a: "True" },
                    { q: "5 - 3 = 3 - 5", a: "False" },
                    { q: "2(3) = 3(2)", a: "True" },
                    { q: "10 √∑ 2 = 2 √∑ 10", a: "False" },
                    { q: "(1+2)+3 = 1+(2+3)", a: "True" }
                ]
            },
            l3_explore: { type: 'sort', title: "Property Sorter", desc: "<strong>Mission:</strong> Identify which property rule is being used.",
                rounds: [
                    { q: "a + b = b + a", ans: "Commutative" },
                    { q: "3(x + 2) = 3x + 6", ans: "Distributive" },
                    { q: "(a+b)+c = a+(b+c)", ans: "Associative" },
                    { q: "x + 0 = x", ans: "Identity" },
                    { q: "5 + (-5) = 0", ans: "Inverse" }
                ]
            },
            l4_engage: { type: 'balance', title: "Balance Scale", desc: "<strong>Mission:</strong> Predict how to keep the scale balanced.",
                rounds: [
                    { q: "We remove 5 from the Left. What must we do to the Right?", opts: ["Subtract 5", "Add 5"], a: "Subtract 5" },
                    { q: "We double the Left side. What must we do to the Right?", opts: ["Multiply by 2", "Divide by 2"], a: "Multiply by 2" },
                    { q: "We add 10 to the Right. What must we do to the Left?", opts: ["Add 10", "Subtract 10"], a: "Add 10" },
                    { q: "We cut the Left side in half. What must we do to the Right?", opts: ["Divide by 2", "Multiply by 2"], a: "Divide by 2" },
                    { q: "What is the goal of solving equations?", opts: ["Isolate Variable", "Remove Variable"], a: "Isolate Variable" }
                ]
            },
            l4_explore: { type: 'wizard', title: "Solution Wizard", desc: "<strong>Mission:</strong> Choose the correct next step to solve the equation.",
                rounds: [
                    { q: "Solve x + 5 = 12", opts: ["Add 5", "Subtract 5"], a: "Subtract 5" },
                    { q: "Solve 3x = 15", opts: ["Divide by 3", "Multiply by 3"], a: "Divide by 3" },
                    { q: "Solve x/4 = 2", opts: ["Multiply by 4", "Divide by 4"], a: "Multiply by 4" },
                    { q: "Solve 2x - 1 = 9 (Step 1)", opts: ["Add 1", "Divide by 2"], a: "Add 1" },
                    { q: "Solve 2x = 10 (Step 2)", opts: ["Divide by 2", "Subtract 2"], a: "Divide by 2" }
                ]
            }
        },
        quizzes: {
            1: [
                {q:"How many terms are in <span class='math-text'>5x - 2y + 8</span>?", opts:["Two","Three","Four","Five"], a:1},
                {q:"Identify the constant in <span class='math-text'>4m - 12</span>.", opts:["4","12","-12","m"], a:2},
                {q:"What is the coefficient of <span class='math-text'>-x</span>?", opts:["1","-1","0","x"], a:1},
                {q:"Which is the variable in <span class='math-text'>3a + 5</span>?", opts:["a","3","5","None"], a:0},
                {q:"What is the coefficient of <span class='math-text'>y/4</span>?", opts:["4y","1/4","0.4","4"], a:1},
                {q:"How many terms in <span class='math-text'>2x + y - z + 5</span>?", opts:["Three","Four","Five","Six"], a:1},
                {q:"What is the constant in the term <span class='math-text'>x</span>?", opts:["0","1","There is no constant","x"], a:2},
                {q:"What is the coefficient in <span class='math-text'>x</span>?", opts:["1","0","x","-1"], a:0},
                {q:"Identify the variables in <span class='math-text'>2ab + c</span>.", opts:["a and b","a, b, and c","c only","a only"], a:1},
                {q:"Terms are separated by which symbols?", opts:["Plus and Minus","Multiply and Divide","Equals","Parentheses"], a:0}
            ],
            2: [
                {q:"Is <span class='math-text'>2x+5</span> an Algebraic Expression or an Equation?", opts:["Expression","Equation","Inequality","Formula"], a:0},
                {q:"Is <span class='math-text'>x=10</span> an Algebraic Expression or an Equation?", opts:["Expression","Equation","Term","Variable"], a:1},
                {q:"Translate: 'The sum of x and 8'", opts:["x - 8","x + 8","8x","x/8"], a:1},
                {q:"Translate: '5 less than y'", opts:["5 - y","y - 5","5 < y","y < 5"], a:1},
                {q:"Which symbol represents 'At most'?", opts:["<",">","‚â§","‚â•"], a:2},
                {q:"Which symbol represents 'Minimum'?", opts:[">","‚â•","‚â§","<"], a:1},
                {q:"What mathematical operation does 'Product' mean?", opts:["Addition","Multiplication","Subtraction","Division"], a:1},
                {q:"What mathematical symbol does 'Is' represent?", opts:["=","<",">","‚â§"], a:0},
                {q:"Translate: 'Twice x'", opts:["x + 2","2x","x^2","x/2"], a:1},
                {q:"Translate: '10 subtracted from z'", opts:["10 - z","z - 10","z < 10","10 < z"], a:1}
            ],
            3: [
                {q:"Identify the property: <span class='math-text'>a + b = b + a</span>", opts:["Commutative Property","Associative Property","Distributive Property","Identity Property"], a:0},
                {q:"Identify the property: <span class='math-text'>3(x + 2) = 3x + 6</span>", opts:["Distributive Property","Identity Property","Associative Property","Commutative Property"], a:0},
                {q:"Identify the property: <span class='math-text'>(1 + 2) + 3 = 1 + (2 + 3)</span>", opts:["Associative Property","Commutative Property","Inverse Property","Identity Property"], a:0},
                {q:"Identify the property: <span class='math-text'>x + 0 = x</span>", opts:["Identity Property","Inverse Property","Associative Property","Commutative Property"], a:0},
                {q:"Identify the property: <span class='math-text'>5 + (-5) = 0</span>", opts:["Identity Property","Inverse Property","Distributive Property","Associative Property"], a:1},
                {q:"Identify the property: <span class='math-text'>1 * x = x</span>", opts:["Identity Property","Commutative Property","Inverse Property","Associative Property"], a:0},
                {q:"Does order matter in Subtraction?", opts:["Yes","No","Sometimes","Only with negatives"], a:1},
                {q:"Simplify <span class='math-text'>2(x + 3)</span>", opts:["2x + 3","2x + 6","x + 6","2x + 5"], a:1},
                {q:"Identify the property: <span class='math-text'>xy = yx</span>", opts:["Commutative Property","Associative Property","Inverse Property","Identity Property"], a:0},
                {q:"Simplify <span class='math-text'>-(x - 2)</span>", opts:["-x - 2","-x + 2","x - 2","x + 2"], a:1}
            ],
            4: [
                {q:"Solve for x: <span class='math-text'>x + 5 = 12</span>", opts:["7","17","-7","-17"], a:0},
                {q:"Solve for x: <span class='math-text'>2x = 20</span>", opts:["10","40","2","18"], a:0},
                {q:"What is the first step for <span class='math-text'>2x - 5 = 11</span>?", opts:["Add 5","Divide by 2","Subtract 11","Multiply by 2"], a:0},
                {q:"Solve for x: <span class='math-text'>-x = 5</span>", opts:["5","-5","0","1"], a:1},
                {q:"Which property solves <span class='math-text'>x - 3 = 10</span>?", opts:["Addition Property of Equality","Multiplication Property of Equality","Distributive Property","Associative Property"], a:0},
                {q:"Which property solves <span class='math-text'>3x = 12</span>?", opts:["Addition Property of Equality","Multiplication Property of Equality","Inverse Property","Identity Property"], a:1},
                {q:"Solve for x: <span class='math-text'>x / 4 = 2</span>", opts:["2","8","6","-2"], a:1},
                {q:"Check if x=2 is a solution for <span class='math-text'>3x = 6</span>", opts:["True","False","Maybe","Undefined"], a:0},
                {q:"Solve for x: <span class='math-text'>2x + 1 = 5</span>", opts:["2","3","4","1"], a:0},
                {q:"What is the inverse operation of Multiplication?", opts:["Addition","Division","Subtraction","Exponentiation"], a:1}
            ]
        }
    };

    /* =========================================
       ENGINE LOGIC (Attached to Window)
       ========================================= */
    window.loadHome = function() {
        document.getElementById('phaseNav').classList.remove('visible');
        document.getElementById('contentArea').innerHTML = content.home;
        window.updateSidebar();
    };

    window.loadLessonIntro = function(id) {
        if(id > unlockedLessons) return;
        currentLesson = id;
        document.getElementById('phaseNav').classList.remove('visible');
        document.getElementById('contentArea').innerHTML = content.lessons[id].intro;
        window.updateSidebar();
        document.getElementById('pBar').style.width = '0%';
    };

    window.startLesson = function(id) {
        document.getElementById('phaseNav').classList.add('visible');
        window.setPhase('engage');
    };

    window.setPhase = function(p) {
        currentPhase = p;
        const phases = ['engage', 'explore', 'explain', 'elaborate', 'evaluate'];
        document.getElementById('pBar').style.width = `${(phases.indexOf(p)+1)*20}%`;

        document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`button[onclick="window.setPhase('${p}')"]`).classList.add('active');

        let html = "";
        
        if(p === 'engage' || p === 'explore') {
            html = `<div id="gameBoard" class="game-board"></div>`; 
            document.getElementById('contentArea').innerHTML = html;
            window.initGame(p); 
        } else if(p === 'evaluate') {
            window.renderQuiz();
        } else {
            html = content.lessons[currentLesson][p];
            html += `<button class="btn btn-next" onclick="window.nextPhase('${p}')">Next ‚û°Ô∏è</button>`;
            document.getElementById('contentArea').innerHTML = html;
        }
    };

    window.nextPhase = function(current) {
        const phases = ['engage', 'explore', 'explain', 'elaborate', 'evaluate'];
        const idx = phases.indexOf(current);
        if(idx < 4) window.setPhase(phases[idx+1]);
    };

    window.updateSidebar = function() {
        document.querySelectorAll('.nav-btn').forEach((b, i) => {
            b.classList.remove('active');
            b.classList.remove('locked');
            if(i+1 > unlockedLessons && i<4) b.classList.add('locked');
        });
        const activeId = document.getElementById('contentArea').innerHTML.includes('Welcome') ? -1 : currentLesson;
        if(activeId > 0 && activeId <= 4) document.getElementById(`nav-${activeId}`).classList.add('active');
    };

    window.addXP = function(n) { xp += n; document.getElementById('totalXP').innerText = xp; };

    /* =========================================
       GAME FUNCTIONS
       ========================================= */
    window.initGame = function(type) {
        gameRound = 0; gameScore = 0;
        window.renderGameRound(type);
    };

    window.renderGameRound = function(type) {
        const data = content.games[`l${currentLesson}_${type}`];
        const board = document.getElementById('gameBoard');
        
        if(gameRound >= 5) {
            board.innerHTML = `<div class="game-board"><h2 style='color:var(--success)'>Stage Complete!</h2><p>Score: ${gameScore}/5</p><button class="btn" onclick="window.nextPhase('${type}')">Continue ‚û°Ô∏è</button></div>`;
            return;
        }

        const round = data.rounds[gameRound];
        let html = `<div class="mission-brief"><strong>MISSION:</strong> ${data.desc}</div><h3>Round ${gameRound+1}/5</h3>`;

        // ENGINE: SELECT (Word Hunter) - No visual cues
        if(data.type === 'select') {
            html += `<h2 style="margin:20px;">Find the <strong>${round.q}</strong></h2>`;
            html += `<div style="font-size:2em; background:white; padding:20px; border-radius:10px;">`;
            // Split sentence into words and make each a clickable button (neutral style)
            round.parts.forEach(word => {
                html += `<span class="highlightable" onclick="window.checkClicker('${word}', '${round.correct}', '${type}')">${word}</span> `;
            });
            html += `</div><div id="fb" class="feedback"></div>`;
        }
        // ENGINE: BALANCE SCALE
        else if(data.type === 'balance') {
            html += `<div class="scale-wrapper">
                        <div class="scale-beam" id="scaleBeam">
                            <div class="plate-rope-l"></div><div class="plate-rope-r"></div>
                            <div class="plate plate-l"></div><div class="plate plate-r"></div>
                        </div>
                        <div class="scale-stand"></div>
                        <div class="scale-base"></div>
                     </div>`;
            html += `<div style="margin-top:20px;"><strong>${round.q}</strong></div><div>`;
            round.opts.forEach(o => html += `<button class="btn btn-outline" onclick="window.checkBalance('${o}','${round.a}','${type}')">${o}</button>`);
            html += `</div><div id="fb" class="feedback"></div>`;
        }
        // ENGINE: CLICKER (Visual Autopsy)
        else if(data.type === 'clicker') {
            html += `<h4>${round.task}</h4><div class="math-display">`;
            round.parts.forEach(p => html += `<span class="highlightable" onclick="window.checkClicker('${p}','${round.ans}','${type}')">${p}</span> `);
            html += `</div><div id="fb" class="feedback"></div>`;
        }
        // ENGINE: BUILDER
        else if(data.type === 'builder') {
            currentBuilder = "";
            html += `<h4>Make: ${round.q}</h4><div class="math-display" id="buildArea">...</div><div>`;
            round.blocks.forEach(b => html += `<span class="token" onclick="window.addToBuild('${b}','${round.ans}','${type}')">${b}</span>`);
            html += `<button class="btn btn-outline" onclick="window.resetBuild()">Reset</button></div><div id="fb" class="feedback"></div>`;
        }
        // STANDARD (Speed, Sort, Truth, Wizard)
        else {
            html += `<div class="math-display">${round.text || round.q}</div><div>`;
            if(data.type === 'sort') {
                ['Commutative','Associative','Distributive','Identity','Inverse'].forEach(p => {
                    html += `<button class="btn btn-outline" onclick="window.checkStd('${p}','${round.ans}','${type}')">${p}</button>`;
                });
            } else if (data.type === 'truth') {
                html += `<button class="btn" style="background:var(--success)" onclick="window.checkStd('True','${round.a}','${type}')">True</button>`;
                html += `<button class="btn" style="background:var(--error)" onclick="window.checkStd('False','${round.a}','${type}')">False</button>`;
            } else {
                round.opts ? round.opts.forEach(o => html += `<button class="btn btn-outline" onclick="window.checkStd('${o}','${round.a}','${type}')">${o}</button>`) : null;
            }
            html += `</div><div id="fb" class="feedback"></div>`;
        }
        board.innerHTML = html;
    };

    // --- CHECKERS ---
    window.checkStd = function(input, correct, type) {
        if(input === correct) {
            window.showFb(true, "Correct!"); window.addXP(10); gameScore++;
            setTimeout(() => { gameRound++; window.renderGameRound(type); }, 1000);
        } else { window.showFb(false, "Try Again!"); }
    };

    window.checkClicker = function(val, correct, type) {
        // Strip spaces for loose comparison
        if(val.trim() === correct.trim()) {
            window.showFb(true, "Correct!"); window.addXP(10); gameScore++;
            setTimeout(() => { gameRound++; window.renderGameRound(type); }, 1000);
        } else { window.showFb(false, "Incorrect."); }
    };

    window.checkBalance = function(input, correct, type) {
        const beam = document.getElementById('scaleBeam');
        if(input === correct) {
            beam.style.transform = "rotate(0deg)";
            window.showFb(true, "Balanced!"); window.addXP(10); gameScore++;
            setTimeout(() => { gameRound++; window.renderGameRound(type); }, 1000);
        } else {
            beam.style.transform = "rotate(15deg)";
            window.showFb(false, "Unbalanced!");
        }
    };

    window.addToBuild = function(val, target, type) {
        currentBuilder += val;
        document.getElementById('buildArea').innerText = currentBuilder;
        if(currentBuilder === target) {
            window.showFb(true, "Built!"); window.addXP(10); gameScore++;
            setTimeout(() => { gameRound++; window.renderGameRound(type); }, 1000);
        } else if (currentBuilder.length >= target.length) {
            window.showFb(false, "Incorrect. Resetting...");
            setTimeout(window.resetBuild, 1000);
        }
    };
    window.resetBuild = function() { currentBuilder = ""; document.getElementById('buildArea').innerText = "..."; document.getElementById('fb').style.display='none'; };

    window.showFb = function(isCorrect, msg) {
        const fb = document.getElementById('fb');
        fb.innerText = msg; fb.className = isCorrect ? "feedback correct" : "feedback wrong";
    };

    // --- QUIZ LOGIC ---
    window.renderQuiz = function() {
        quizAnswers = new Array(10).fill(null);
        const qData = content.quizzes[currentLesson];
        let html = `<div class="content-card"><h2>‚úÖ Mastery Quiz</h2><p>Select answers. Score 7/10 to pass.</p>`;
        qData.forEach((q, i) => {
            let opts = "";
            q.opts.forEach((o, optIdx) => {
                opts += `<span class="quiz-opt" id="q${i}_o${optIdx}" onclick="window.selectQuizOpt(${i}, ${optIdx})">${o}</span>`;
            });
            html += `<div class="quiz-item"><p><strong>${i+1}.</strong> ${q.q}</p>${opts}</div>`;
        });
        html += `<button class="btn" style="width:100%; margin-top:20px;" onclick="window.submitQuiz()">Submit Answers</button></div>`;
        document.getElementById('contentArea').innerHTML = html;
    };

    window.selectQuizOpt = function(qIdx, oIdx) {
        quizAnswers[qIdx] = oIdx;
        for(let i=0; i<4; i++) {
            const el = document.getElementById(`q${qIdx}_o${i}`);
            if(el) el.classList.remove('selected');
        }
        document.getElementById(`q${qIdx}_o${oIdx}`).classList.add('selected');
    };

    window.submitQuiz = function() {
        if(quizAnswers.includes(null)) { alert("Please answer all questions."); return; }
        
        const correctAnswers = content.quizzes[currentLesson].map(q => q.a);
        let score = 0;
        quizAnswers.forEach((ans, i) => { if(ans === correctAnswers[i]) score++; });

        let html = `<div class="quiz-score-box"><h1>Score: ${score} / 10</h1>`;
        if(score >= 7) {
            html += `<h3 style="color:var(--success)">PASSED!</h3><p>Next level unlocked.</p><button class="btn" onclick="window.unlockNext()">Next Level ‚û°Ô∏è</button>`;
            window.addXP(score * 20);
        } else {
            html += `<h3 style="color:var(--error)">TRY AGAIN</h3><p>You need 7/10.</p><button class="btn" onclick="window.renderQuiz()">Retry</button>`;
        }
        html += `</div>`;
        document.getElementById('contentArea').innerHTML = html;
    };

    window.unlockNext = function() {
        if(unlockedLessons < 4) {
            unlockedLessons++;
            window.loadLessonIntro(currentLesson + 1);
        } else {
            let overlay = document.createElement('div');
            overlay.style.position = 'fixed'; overlay.style.top = '0'; overlay.style.left = '0';
            overlay.style.width = '100%'; overlay.style.height = '100%';
            overlay.style.background = 'rgba(0,0,0,0.9)'; overlay.style.color = 'white';
            overlay.style.display = 'flex'; overlay.style.flexDirection = 'column';
            overlay.style.justifyContent = 'center'; overlay.style.alignItems = 'center'; overlay.style.zIndex = '1000';
            overlay.innerHTML = `<h1>üéâ MISSION COMPLETE! üéâ</h1><p style="font-size:2em;">You mastered all 4 levels!</p><button class="btn" onclick="location.reload()">Play Again</button>`;
            document.body.appendChild(overlay);
        }
    };

    window.checkExact = function(id, ans) {
        let val = document.getElementById(id).value.replace(/\s/g,'').toLowerCase();
        if(val === ans.toLowerCase()) { alert("Correct! +20 XP"); window.addXP(20); } else { alert("Try again."); }
    };
    window.checkMulti = function(id, opts) {
        let val = document.getElementById(id).value.replace(/\s/g,'').toLowerCase();
        if(opts.includes(val)) { alert("Correct! +20 XP"); window.addXP(20); } else { alert("Try again."); }
    };

    // START
    window.loadHome();

})();
</script>
</body>
</html>
